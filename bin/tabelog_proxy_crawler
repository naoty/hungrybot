#!/usr/bin/env ruby

require "net/http"
require "nokogiri"
require "geocoder"

USER_AGENT = "hungrybot"

Geocoder.configure do |config|
  config.language = :ja
  config.units = :km
end

class TabelogProxyCrawler
  def initialize(proxy_url, port = 8080)
    @result = Struct.new("Result", :name, :latitude, :longitude)
    @proxy = Net::HTTP::Proxy(proxy_url, port)
  end

  def run(url_string)
    uri = URI.parse(url_string)
    response = @proxy.new(uri.host).get(uri.path, { "User-Agent" => USER_AGENT })
    document = Nokogiri::HTML(response.body)

    table = document.xpath("//table[@class='rst-data']")
    name = table.xpath("//tr[@class='rst-name table-first']/td").inner_text.strip

    address = table.xpath("//tr[@class='address']/td/p")
    region = address.xpath("//span[@property='v:region']").inner_text.strip
    locality = address.xpath("//span[@property='v:locality']").inner_text.strip
    location = Geocoder.search(region + locality).first
    latitude, longitude = location.coordinates

    @result.new(name, latitude, longitude)
  end
end

crawler = TabelogProxyCrawler.new("116.58.185.6")
result = crawler.run("http://tabelog.com/tokyo/A1303/A130302/13130661/")
puts "name: #{result.name}"
puts "latitude: #{result.latitude}"
puts "longitude: #{result.longitude}"

